user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
        worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format  main  '$remote_addr - $real_ip - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';

	charset utf-8;

	client_body_timeout 	12s;
	client_header_timeout 	12s;
	keepalive_timeout 		10s;
	send_timeout 			5s;
	resolver_timeout  		5s;

	client_body_buffer_size 	16k;
	client_header_buffer_size 	1k;
	client_max_body_size 		1m;
	large_client_header_buffers 4 8k;

	gzip             on;
	gzip_comp_level  2;
	gzip_min_length  1000;
	gzip_proxied     expired no-cache no-store private auth;
	gzip_types       text/plain application/x-javascript text/xml text/css application/xml application/json;

	server_tokens       off;

    map $status $ratelimit_status {
        429 1;
        default 0;
    }

    geo $geo_limit {
        default 1;
        10.0.0.0/8 0;
        172.16.0.0/12 0;
        192.168.0.0/16 0;
    }

    map $geo_limit $limit_per_ip_and_uri {
        0 "";
        1 $real_ip:$uri;
    }

    map $geo_limit $limit_per_ip {
        0 "";
        1 $real_ip;
    }

    map $geo_limit $limit_per_server {
        0 "";
        1 $server_name;
    }

    limit_req_zone $limit_per_ip_and_uri  zone=user_api_limit_request_per_ip_and_uri:1m  rate=3r/s;
    limit_req_zone $limit_per_ip          zone=user_api_limit_request_per_ip:1m          rate=10r/s;
    limit_req_zone $limit_per_server      zone=user_api_limit_request_per_server:1m      rate=300r/s;

    limit_req_zone $limit_per_ip_and_uri  zone=boss_api_limit_request_per_ip_and_uri:1m  rate=3r/s;
    limit_req_zone $limit_per_ip          zone=boss_api_limit_request_per_ip:1m          rate=10r/s;
    limit_req_zone $limit_per_server      zone=boss_api_limit_request_per_server:1m      rate=300r/s;

    limit_req_zone $limit_per_ip_and_uri  zone=admin_api_limit_request_per_ip_and_uri:1m  rate=3r/s;
    limit_req_zone $limit_per_ip          zone=admin_api_limit_request_per_ip:1m         rate=10r/s;
    limit_req_zone $limit_per_server      zone=admin_api_limit_request_per_server:1m     rate=100r/s;

    upstream user-api {
        least_conn;
        server localhost:5001;
        server localhost:5002;
    }

    upstream boss-api {
        least_conn;
        server localhost:4001;
        server localhost:4002;
    }

    upstream admin {
        least_conn;
        server localhost:5101;
        server localhost:5102;
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl ipv6only=on;
        server_name dev.threedollars.co.kr;

        ssl_certificate /etc/letsencrypt/live/dev.threedollars.co.kr/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/dev.threedollars.co.kr/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        if ($http_x_forwarded_for ~ "^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})") {
            set $real_ip $1;
        }
        if ($real_ip = "") {
            set $real_ip $remote_addr;
        }

        location /api/ {
            proxy_pass http://user-api;
            proxy_redirect off;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $host;

            access_log /home/ubuntu/logs/nginx-user/access.log;
            access_log /home/ubuntu/logs/nginx-user/ratelimit.log main if=$ratelimit_status;
            error_log /home/ubuntu/logs/nginx-user/error.log;

            limit_req zone=user_api_limit_request_per_ip_and_uri;
            limit_req zone=user_api_limit_request_per_ip;
            limit_req zone=user_api_limit_request_per_server;
            limit_req_status        429;
            limit_req_log_level     error;
        }

        location /boss/ {
            proxy_pass http://boss-api;
            proxy_redirect off;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $host;

            access_log /home/ubuntu/logs/nginx-boss/access.log;
            access_log /home/ubuntu/logs/nginx-boss/ratelimit.log main if=$ratelimit_status;
            error_log /home/ubuntu/logs/nginx-boss/error.log;

            limit_req zone=boss_api_limit_request_per_ip_and_uri;
            limit_req zone=boss_api_limit_request_per_ip;
            limit_req zone=boss_api_limit_request_per_server;
            limit_req_status        429;
            limit_req_log_level     error;
        }

        location /admin/ {
            proxy_pass http://admin;
            proxy_redirect off;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $host;

            access_log /home/ubuntu/logs/nginx-admin/access.log;
            access_log /home/ubuntu/logs/nginx-admin/ratelimit.log main if=$ratelimit_status;
            error_log /home/ubuntu/logs/nginx-admin/error.log;

            limit_req zone=admin_api_limit_request_per_ip_and_uri;
            limit_req zone=admin_api_limit_request_per_ip;
            limit_req zone=admin_api_limit_request_per_server;
            limit_req_status        429;
            limit_req_log_level     error;
        }

        location /nginx-status {
            include /etc/nginx/monitoring_whitelist.conf;
            stub_status;
            deny all;
        }
    }

    server {
        listen 80;
        listen [::]:80;
        server_name dev.threedollars.co.kr;

        return 301 https://$server_name$request_uri;
    }
}
